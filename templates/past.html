{% extends 'base.html' %}

{% block content %}
  <section class="filter" style="margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:12px">
    <form method="get" class="filter-form" style="flex:1">
      <label>Show:</label>
      <select name="preset">
        <option value="all" {% if preset=='all' %}selected{% endif %}>All</option>
        <option value="week" {% if preset=='week' %}selected{% endif %}>Last week</option>
        <option value="month" {% if preset=='month' %}selected{% endif %}>Last month</option>
        <option value="year" {% if preset=='year' %}selected{% endif %}>Last year</option>
        <option value="custom" {% if preset=='custom' %}selected{% endif %}>Custom range</option>
      </select>
  <div id="custom-range" style="display: {{ 'block' if preset=='custom' else 'none' }};">
        <label>From</label>
        <input type="date" name="start" value="{{ start or '' }}" />
        <label>To</label>
        <input type="date" name="end" value="{{ end or '' }}" />
      </div>
      <button class="btn" type="submit">Filter</button>
    </form>
    <div style="margin-left:12px;">
      <a class="btn primary" href="/new">New Entry</a>
    </div>
  </section>

  <section class="entries">
    <form id="bulk-form" method="post" action="/delete_bulk">
      <input type="hidden" name="next" value="{{ request.full_path }}" />
      <div class="bulk-actions" style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="select-all-past" /> Select all</label>
        <div>
          <button id="bulk-delete-btn" class="btn" type="button" style="display:none" disabled>Delete selected</button>
        </div>
      </div>
      {% if entries %}
        {% for e in entries %}
          <article class="entry">
            <div class="entry-row">
              <input type="checkbox" name="selected" value="{{ e.id }}" class="select-checkbox" />
              <div class="entry-main">
                <div class="entry-header">
                  <h2>{{ e.title or 'Untitled' }}</h2>
                  <div class="entry-controls">
                    <a href="/edit/{{ e.id }}" class="btn" title="Edit">âœŽ</a>
                    <form action="/delete/{{ e.id }}" method="post" class="delete-form-inline" onsubmit="return confirm('Delete this entry?');" style="display:inline">
                      <button type="submit" class="btn btn-delete" aria-label="Delete">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M8 6v12a2 2 0 002 2h4a2 2 0 002-2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                      </button>
                    </form>
                  </div>
                </div>
                <time>{{ e.display_time or e.created_at }}</time>
                <div class="entry-content">{{ e.content }}</div>
              </div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p>No entries match this range. Try a different filter.</p>
      {% endif %}
    </form>
    <!-- bulk delete confirm modal -->
    <div id="bulk-confirm" class="modal" style="display:none">
      <div class="modal-inner">
        <p>Delete selected entries?</p>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
          <button id="bulk-confirm-yes" class="btn primary">Delete</button>
          <button id="bulk-confirm-no" class="btn">Cancel</button>
        </div>
      </div>
    </div>
  </section>
  <script>
    (function(){
      const preset = document.querySelector('select[name="preset"]');
      const custom = document.getElementById('custom-range');
      function toggle(){
        if(!preset) return;
        if(preset.value === 'custom') custom.style.display = 'block';
        else custom.style.display = 'none';
      }
      if(preset){ preset.addEventListener('change', toggle); }
      // init
      toggle();
      // bulk select logic
      const selectAll = document.getElementById('select-all-past');
      const bulkBtn = document.getElementById('bulk-delete-btn');
      const bulkForm = document.getElementById('bulk-form');
      const bulkModal = document.getElementById('bulk-confirm');
      const bulkYes = document.getElementById('bulk-confirm-yes');
      const bulkNo = document.getElementById('bulk-confirm-no');
      function updateBulk(){
        const boxes = document.querySelectorAll('.select-checkbox');
        let any = false;
        boxes.forEach(b => { if(b.checked) any = true; });
        if(bulkBtn){ bulkBtn.disabled = !any; bulkBtn.style.display = any ? 'inline-block' : 'none'; }
      }
      if(selectAll){
        selectAll.addEventListener('change', ()=>{
          const boxes = document.querySelectorAll('.select-checkbox');
          boxes.forEach(b => b.checked = selectAll.checked);
          updateBulk();
        });
      }
      document.addEventListener('change', (e)=>{ if(e.target && e.target.classList && e.target.classList.contains('select-checkbox')) updateBulk(); });

      // open modal when bulk delete clicked, only if selection exists
      if(bulkBtn){
        bulkBtn.addEventListener('click', ()=>{
          if(bulkBtn.disabled) return;
          if(bulkModal) bulkModal.style.display = 'flex';
        });
      }
      if(bulkNo) bulkNo.addEventListener('click', ()=>{ if(bulkModal) bulkModal.style.display = 'none'; });
      if(bulkYes) bulkYes.addEventListener('click', ()=>{ if(bulkForm) bulkForm.submit(); });
    })();
  </script>
{% endblock %}
